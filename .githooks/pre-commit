#!/bin/bash

# Pre-commit hook to enforce NO MIGRATION POLICY
# 检查提交中是否包含违反"无迁移无兼容"政策的代码

echo "🔍 检查无迁移无兼容政策违规..."

# 定义违规模式（聚焦真实迁移/兼容操作，避免误报）
MIGRATION_PATTERNS=(
    "ALTER TABLE[[:space:]].*(ADD[[:space:]]+COLUMN|RENAME[[:space:]]+COLUMN|RENAME[[:space:]]+TO|DROP[[:space:]]+COLUMN)"
    "_migrate_"
    "backward_compatibility"
)

# 检查暂存的文件
# 仅检查源码文件，排除tests和debug目录以避免误报
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py|sql)$' | grep -Ev '^(tests/|debug/)')

if [ -z "$STAGED_FILES" ]; then
    echo "✅ 无Python/SQL文件需要检查"
    exit 0
fi

VIOLATIONS_FOUND=false

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        for pattern in "${MIGRATION_PATTERNS[@]}"; do
            if git diff --cached "$file" | grep -qE "$pattern"; then
                echo "❌ 违规: $file 包含禁止的迁移模式: $pattern"
                VIOLATIONS_FOUND=true
            fi
        done
    fi
done

if [ "$VIOLATIONS_FOUND" = true ]; then
    echo ""
    echo "🚨 发现违反无迁移无兼容政策的代码！"
    echo "📖 请查看 NO_MIGRATION_POLICY.md 了解详情"
    echo "🔧 请移除所有迁移相关代码后重新提交"
    echo ""
    exit 1
fi

echo "✅ 无迁移政策检查通过"
exit 0