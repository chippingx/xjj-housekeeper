#!/bin/bash

# Pre-commit hook to enforce NO MIGRATION POLICY
# æ£€æŸ¥æäº¤ä¸­æ˜¯å¦åŒ…å«è¿å"æ— è¿ç§»æ— å…¼å®¹"æ”¿ç­–çš„ä»£ç 

echo "ğŸ” æ£€æŸ¥æ— è¿ç§»æ— å…¼å®¹æ”¿ç­–è¿è§„..."

# å®šä¹‰è¿è§„æ¨¡å¼
MIGRATION_PATTERNS=(
    "_migrate_"
    "ALTER TABLE.*ADD COLUMN"
    "column_exists"
    "backward_compatibility"
    "migration"
    "migrate"
    "TestDatabaseMigration"
    "test_.*migration"
    "PRAGMA table_info"
)

# æ£€æŸ¥æš‚å­˜çš„æ–‡ä»¶
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py|sql)$')

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… æ— Python/SQLæ–‡ä»¶éœ€è¦æ£€æŸ¥"
    exit 0
fi

VIOLATIONS_FOUND=false

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        for pattern in "${MIGRATION_PATTERNS[@]}"; do
            if git diff --cached "$file" | grep -q "$pattern"; then
                echo "âŒ è¿è§„: $file åŒ…å«ç¦æ­¢çš„è¿ç§»æ¨¡å¼: $pattern"
                VIOLATIONS_FOUND=true
            fi
        done
    fi
done

if [ "$VIOLATIONS_FOUND" = true ]; then
    echo ""
    echo "ğŸš¨ å‘ç°è¿åæ— è¿ç§»æ— å…¼å®¹æ”¿ç­–çš„ä»£ç ï¼"
    echo "ğŸ“– è¯·æŸ¥çœ‹ NO_MIGRATION_POLICY.md äº†è§£è¯¦æƒ…"
    echo "ğŸ”§ è¯·ç§»é™¤æ‰€æœ‰è¿ç§»ç›¸å…³ä»£ç åé‡æ–°æäº¤"
    echo ""
    exit 1
fi

echo "âœ… æ— è¿ç§»æ”¿ç­–æ£€æŸ¥é€šè¿‡"
exit 0